<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TokyoGirlsHub 総合分析ダッシュボード</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
            background-color: #0c0a09;
            background-image: linear-gradient(to bottom right, #111827, #1e1b4b, #111827);
            color: #E5E7EB;
        }
        .accent-text { color: #06b6d4; }
        .card {
            background-color: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(56, 189, 248, 0.2), 0 0 15px rgba(56, 189, 248, 0.1);
            border-color: rgba(56, 189, 248, 0.4);
        }
        #monthSelector {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-color: #1f2937; border: 1px solid #374151; color: #E5E7EB;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2306b6d4' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transition: transform 0.3s; transform: scale(0.95); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table th, .styled-table td { padding: 0.75rem 1rem; text-align: left; white-space: nowrap; }
        .styled-table thead tr { background-color: rgba(55, 65, 81, 0.5); color: #d1d5db; font-size: 0.875rem; }
        .styled-table thead th { cursor: pointer; position: relative; }
        .styled-table tbody tr { border-bottom: 1px solid #374151; transition: background-color 0.2s ease; }
        .styled-table tbody tr.clickable:hover { background-color: rgba(55, 65, 81, 0.3); cursor: pointer; }
        .styled-table thead th .sort-arrow { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); opacity: 0.5; }
        .styled-table thead th.sorted .sort-arrow { opacity: 1; }
        .nav-btn {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-btn.active {
            color: #06b6d4;
            border-bottom-color: #06b6d4;
        }
        .slicer-btn {
            cursor: pointer; transition: all 0.2s ease-in-out;
            font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 9999px;
            border: 1px solid transparent;
        }
        .slicer-btn.active { transform: scale(1.05); }
        .slicer-btn:not(.active) { opacity: 0.4; }
        .lang-btn { background-color: #312e81; color: #e0e7ff; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; padding: 0.3rem 0.7rem; transition: all 0.2s; opacity: 0.6; }
        .lang-btn.active { opacity: 1; background-color: #06b6d4; color: #111827; box-shadow: 0 0 10px rgba(6, 182, 212, 0.5); }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold accent-text" data-lang-key="mainTitle">TokyoGirlsHub 総合分析</h1>
                <p class="text-gray-400" data-lang-key="subTitle">統合パフォーマンスダッシュボード</p>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 mt-4 sm:mt-0">
                 <div id="language-switcher" class="flex items-center space-x-2 mr-2">
                     <button data-lang="ja" class="lang-btn active">JP</button>
                     <button data-lang="en" class="lang-btn">EN</button>
                     <button data-lang="zh-HK" class="lang-btn">繁</button>
                 </div>
                 <select id="monthSelector" class="rounded-full focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5 cursor-pointer"></select>
                 <button id="refreshDataBtn" class="bg-cyan-500 text-gray-900 font-semibold rounded-full px-4 py-2 text-sm flex items-center space-x-2 flex-shrink-0 hover:bg-cyan-400 transition">
                     <i class="fas fa-sync-alt"></i>
                     <span data-lang-key="refreshBtn">更新</span>
                 </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex items-center justify-center space-x-4 sm:space-x-8 mb-8 border-b border-gray-700">
            <button class="nav-btn py-3 px-2 font-semibold text-gray-400 hover:text-cyan-400 active" data-section="all" data-lang-key="navAll">すべて表示</button>
            <button class="nav-btn py-3 px-2 font-semibold text-gray-400 hover:text-cyan-400" data-section="customer-deep-dive" data-lang-key="navCustomer">顧客動向</button>
            <button class="nav-btn py-3 px-2 font-semibold text-gray-400 hover:text-cyan-400" data-section="cast-analysis" data-lang-key="navCast">キャスト分析</button>
            <button class="nav-btn py-3 px-2 font-semibold text-gray-400 hover:text-cyan-400" data-section="race-analysis" data-lang-key="navRace">人種別分析</button>
        </nav>

        <main>
            <!-- Section: Performance Overview -->
            <section id="performance-overview" class="dashboard-section grid grid-cols-12 gap-6 mb-6">
                <div class="col-span-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card p-6 text-center"><p class="text-sm text-gray-400" data-lang-key="kpiSales">売上合計</p><p id="kpi-sales" class="text-3xl font-bold">¥0</p></div>
                    <div class="card p-6 text-center"><p class="text-sm text-gray-400" data-lang-key="kpiProfit">粗利合計</p><p id="kpi-profit" class="text-3xl font-bold">¥0</p></div>
                    <div class="card p-6 text-center"><p class="text-sm text-gray-400" data-lang-key="kpiCost">原価合計</p><p id="kpi-cost" class="text-3xl font-bold">¥0</p></div>
                    <div class="card p-6 text-center"><p class="text-sm text-gray-400" data-lang-key="kpiCustomers">客数合計</p><p id="kpi-customers" class="text-3xl font-bold">0</p></div>
                    <div class="card p-6 text-center"><p class="text-sm text-gray-400" data-lang-key="kpiMarginRate">粗利率</p><p id="kpi-margin-rate" class="text-3xl font-bold">0%</p></div>
                    <div class="card p-6 text-center"><p class="text-sm text-gray-400" data-lang-key="kpiAvgSpend">平均客単価</p><p id="kpi-avg-spend" class="text-3xl font-bold">¥0</p></div>
                </div>
                <div class="col-span-12 card p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold accent-text mb-3 sm:mb-0" data-lang-key="salesTrendTitle">売上・原価・粗利率 推移</h2>
                        <div id="salesChartToggles" class="flex space-x-2">
                            <button data-dataset-index="0" class="slicer-btn active" style="background-color: #f59e0b; color: white;" data-lang-key="salesLabel">売上</button>
                            <button data-dataset-index="1" class="slicer-btn active" style="background-color: #9ca3af; color: #1f2937;" data-lang-key="costLabel">原価</button>
                            <button data-dataset-index="2" class="slicer-btn active" style="background-color: #06b6d4; color: white;" data-lang-key="marginRateLabel">粗利率</button>
                        </div>
                    </div>
                    <div class="h-80"> <canvas id="salesTrendChart"></canvas> </div>
                </div>
                <div class="col-span-12 md:col-span-6 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="profitTrendTitle">粗利推移</h2>
                    <div class="h-80"> <canvas id="profitBarChart"></canvas> </div>
                </div>
                <div class="col-span-12 md:col-span-6 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="customerTrendTitle">客数推移（新規・リピーター）</h2>
                    <div class="h-80"> <canvas id="customersTrendChart"></canvas> </div>
                </div>
            </section>

            <!-- Section: Customer Deep Dive -->
            <section id="customer-deep-dive" class="dashboard-section grid grid-cols-12 gap-6 mb-6">
                <div class="col-span-12 lg:col-span-4 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="callTypeTitle">コール種別 比率</h2>
                    <div class="h-96 flex items-center justify-center"><canvas id="call-type-chart"></canvas></div>
                </div>
                <div class="col-span-12 lg:col-span-8 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="areaMapTitle">人気配達エリア</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-96">
                        <div class="h-full">
                            <canvas id="tokyo-barchart"></canvas>
                        </div>
                        <div class="overflow-y-auto">
                            <table class="styled-table">
                                <thead id="area-details-table-head"></thead>
                                <tbody id="area-details-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-span-12 lg:col-span-8 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="arrivalTineTitle">入客時間帯</h2>
                    <div class="h-96"> <canvas id="arrival-time-chart"></canvas> </div>
                </div>
                <div class="col-span-12 lg:col-span-4 card p-6 flex flex-col">
                    <h2 class="text-xl font-semibold accent-text mb-4 flex-shrink-0" data-lang-key="sourceRatioTitle">経由元 比率</h2>
                    <div class="relative flex-grow overflow-y-auto"> <canvas id="source-ratio-chart"></canvas> </div>
                </div>
            </section>

            <!-- Section: Cast Analysis -->
            <section id="cast-analysis" class="dashboard-section grid grid-cols-12 gap-6 mb-6">
                 <div class="col-span-12 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="castPerfTitle">キャスト パフォーマンス</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400" data-lang-key="kpiTotalPayout">女子給 合計</p>
                            <p id="kpi-total-payout" class="text-2xl font-bold">¥0</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400" data-lang-key="kpiAvgPayout">1人あたり平均女子給</p>
                            <p id="kpi-avg-payout" class="text-2xl font-bold">¥0</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="styled-table">
                            <thead id="cast-table-head">
                                <tr>
                                    <th data-sort="name"><span data-lang-key="castNameCol">キャスト名</span><span class="sort-arrow"></span></th>
                                    <th data-sort="customerCount"><span data-lang-key="totalCustomersCol">総客数</span><span class="sort-arrow"></span></th>
                                    <th data-sort="totalPayout"><span data-lang-key="totalPayoutCol">女子給合計</span><span class="sort-arrow"></span></th>
                                    <th data-sort="avgPayout"><span data-lang-key="avgPayoutCol">客単価女子給</span><span class="sort-arrow"></span></th>
                                    <th data-sort="repeatCount"><span data-lang-key="repeatCountCol">被リピート数</span><span class="sort-arrow"></span></th>
                                    <th data-sort="repeatRate"><span data-lang-key="repeatRateCol">リピート率</span><span class="sort-arrow"></span></th>
                                    <th data-sort="optionRate"><span data-lang-key="optionRateCol">オプション付与率</span><span class="sort-arrow"></span></th>
                                    <th data-sort="hamanoCustomerCount"><span data-lang-key="hamanoCountCol">濱野経由数</span><span class="sort-arrow"></span></th>
                                    <th data-sort="hamanoRate"><span data-lang-key="hamanoRateCol">濱野経由率</span><span class="sort-arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="cast-performance-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Section: Race Analysis -->
            <section id="race-analysis" class="dashboard-section grid grid-cols-12 gap-6 mb-6">
                <div class="col-span-12 card p-6">
                    <h2 class="text-xl font-semibold accent-text mb-4" data-lang-key="raceAnalysisTitle">人種別 分析</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 h-80 flex items-center justify-center">
                            <canvas id="race-ratio-chart"></canvas>
                        </div>
                        <div class="lg:col-span-2 overflow-x-auto">
                            <table class="styled-table">
                                <thead id="race-analysis-table-head"></thead>
                                <tbody id="race-analysis-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="ward-detail-modal" class="modal-overlay">
        <div class="card modal-content w-full max-w-6xl h-full max-h-[90vh] p-6 flex flex-col relative">
            <button data-close-modal="ward-detail-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10"><i class="fas fa-times fa-2x"></i></button>
            <h2 class="text-2xl font-bold accent-text mb-4"><span id="ward-modal-name"></span> <span data-lang-key="wardModalTitle">詳細分析</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-gray-400" data-lang-key="totalCustomersCol">総客数</p><p id="ward-kpi-customers" class="text-2xl font-bold">0</p></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-gray-400" data-lang-key="totalPaymentCol">総支払額</p><p id="ward-kpi-payment" class="text-2xl font-bold">¥0</p></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><p class="text-sm text-gray-400" data-lang-key="avgPaymentCol">平均支払額</p><p id="ward-kpi-avg-payment" class="text-2xl font-bold">¥0</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow min-h-0">
                <div class="card p-4 flex flex-col"><h3 class="font-semibold text-center mb-2" data-lang-key="raceRatioTitle">人種比率</h3><div class="flex-grow h-64"><canvas id="ward-race-chart"></canvas></div></div>
                <div class="card p-4 flex flex-col"><h3 class="font-semibold text-center mb-2" data-lang-key="topOptionsTitle">人気オプション</h3><div class="flex-grow h-64"><canvas id="ward-options-chart"></canvas></div></div>
                <div class="card p-4 flex flex-col"><h3 class="font-semibold text-center mb-2" data-lang-key="sourceTitle">経由元</h3><div class="flex-grow h-64"><canvas id="ward-source-chart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div id="castDetailModal" class="modal-overlay">
        <div class="modal-content card max-w-6xl h-full max-h-[90vh] p-6 flex flex-col relative">
            <button data-close-modal="castDetailModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10"><i class="fas fa-times fa-2x"></i></button>
            <h2 class="text-2xl font-bold accent-text mb-6"><span id="cast-modal-name"></span> <span data-lang-key="wardModalTitle">詳細分析</span></h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
                <div class="card p-4 flex flex-col"><h3 class="font-semibold mb-2 text-center text-gray-300" data-lang-key="topOptionsTitle">人気オプション</h3><div class="flex-grow h-64"><canvas id="cast-options-chart"></canvas></div></div>
                <div class="card p-4 flex flex-col overflow-y-auto"><h3 class="font-semibold mb-2 text-center text-gray-300" data-lang-key="periodDataTitle">期間別データ</h3><div class="overflow-x-auto"><table class="styled-table"><thead id="cast-detail-table-head"></thead><tbody id="cast-detail-table-body"></tbody></table></div></div>
            </div>
        </div>
    </div>
    
    <div id="raceDetailModal" class="modal-overlay">
        <div class="modal-content card max-w-6xl h-full max-h-[90vh] p-6 flex flex-col relative">
            <button data-close-modal="raceDetailModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10"><i class="fas fa-times fa-2x"></i></button>
            <h2 class="text-2xl font-bold accent-text mb-6"><span id="race-modal-name"></span> <span data-lang-key="wardModalTitle">詳細分析</span></h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><div class="card p-4"><h3 class="font-semibold mb-2 text-center text-gray-300" data-lang-key="sourceRankingTitle">経由元ランキング</h3><div class="h-64"><canvas id="race-source-chart"></canvas></div></div><div class="card p-4"><h3 class="font-semibold mb-2 text-center text-gray-300" data-lang-key="topOptionsRankingTitle">人気オプションランキング</h3><div class="h-64"><canvas id="race-options-chart"></canvas></div></div></div>
            <div class="card p-4 flex-grow overflow-y-auto"><h3 class="font-semibold mb-2 text-center text-gray-300" data-lang-key="periodDataTitle">期間別データ</h3><div class="overflow-x-auto"><table class="styled-table"><thead id="race-detail-table-head"></thead><tbody id="race-detail-table-body"></tbody></table></div></div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQSsuwQKznZw-P1MlRC1lQiB0kUO7C-HUz-WrdG23xPH0p_BEnm6TX2Qz1mIB1-s9-UV4QfxWkxvRaD/pub?gid=1213353290&single=true&output=csv';
        
        let allData = [];
        let allParsedCustomerData = [];
        let currentFilteredData = [];
        let currentCastStats = {};
        let currentSort = { key: 'totalPayout', direction: 'desc' };
        let currentLang = 'ja';

        const ALL_OPTIONS = ["オナニー鑑賞", "電マ/バイブ", "聖水", "足コキ", "即尺", "アナル舐め", "パンツ持ち帰り", "パンスト破り", "コスプレ", "ごっくん", "3P", "イラマチオ", "顔射", "2回戦(60分限定)", "写真動画撮影", "AF"];
        const formatYen = (value) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value || 0);
        const formatPercent = (value) => (value || 0).toLocaleString('ja-JP', { style: 'percent', minimumFractionDigits: 1 });
        const PREMIUM_COLORS = ['#f472b6', '#fbbf24', '#a78bfa', '#f87171', '#4ade80', '#fb7185', '#e879f9', '#818cf8', '#f59e0b', '#34d399'];

        // --- Data Parsing ---
        function csvToArrayOfObjects(csvText) {
            const data = [];
            const headerMatch = csvText.match(/^(.*)\r?\n/);
            if (!headerMatch) return [];
            const header = headerMatch[1].split(',').map(h => h.trim());
            const rowsText = csvText.substring(headerMatch[0].length);
            const records = rowsText.split(/(?=\d{1,2}\/\d{1,2},)/).filter(r => r.trim());
            for (const record of records) {
                const values = []; let currentVal = ''; let inQuotes = false;
                for (let i = 0; i < record.length; i++) {
                    const char = record[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { values.push(currentVal.trim()); currentVal = ''; }
                    else currentVal += char;
                }
                values.push(currentVal.trim());
                if (values.length === header.length) {
                    const obj = {};
                    header.forEach((key, index) => {
                        let value = values[index];
                        if (value.startsWith('"') && value.endsWith('"')) value = value.substring(1, value.length - 1);
                        obj[key] = value.replace(/""/g, '"');
                    });
                    data.push(obj);
                }
            }
            return data;
        }

        function getCorrectDate(dateStr) {
            if (!dateStr || !/^\d{1,2}\/\d{1,2}$/.test(dateStr)) return null;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const currentYear = today.getFullYear();
            let date = new Date(`${currentYear}/${dateStr}`);
            if (isNaN(date.getTime())) return null;
            if (date > today) date.setFullYear(currentYear - 1);
            return date;
        }
        
        function parseCustomerDetails(detailString, recordDate) {
            if (!detailString || !recordDate) return [];
            const customerRecords = [];
            const lines = detailString.split('\n').filter(line => line.trim() !== '');
            for (const line of lines) {
                const foundOptions = ALL_OPTIONS.filter(opt => line.includes(opt));
                let tempLine = line;
                foundOptions.forEach(opt => { tempLine = tempLine.replace(opt, ''); });
                tempLine = tempLine.replace(/"/g, '').replace(/, ,/g, ',').replace(/,,/g, ',');
                const parts = tempLine.split(',').map(p => p.trim());
                if (parts.length >= 8) {
                    let source = parts[5] || '不明';
                    if (source.includes('濱野マイ客') || source.includes('濱野引き') || source.includes('濱野マイ客紹介')) {
                        source = '濱野経由';
                    }
                    customerRecords.push({
                        date: recordDate, time: parts[0] || '', castName: (parts[1] || '').split('(')[0].trim(),
                        race: (parts[2] || '不明').trim(), callInfo: parts[3] || '', payment: parseInt(parts[4], 10) || 0,
                        source: source, duration: parseInt(parts[6], 10) || 0, payout: parseInt(parts[7], 10) || 0,
                        options: foundOptions, repeatSourceCast: (parts[8] || '').split('(')[0].trim() || null
                    });
                }
            }
            return customerRecords;
        }

        // --- Main Data Flow & Update Logic ---
        function fetchDataAndProcess() {
            fetch(`${GOOGLE_SHEET_URL}&_=${new Date().getTime()}`)
                .then(response => response.text())
                .then(csvText => {
                    allData = csvToArrayOfObjects(csvText);
                    allParsedCustomerData = allData.flatMap(dailyRecord => {
                        const recordDate = getCorrectDate(dailyRecord['日付']);
                        return parseCustomerDetails(dailyRecord['顧客詳細'], recordDate);
                    });
                    populateMonthSelector();
                    updateDashboard(document.getElementById('monthSelector').value);
                }).catch(error => console.error('Failed to fetch/process data:', error));
        }

        function populateMonthSelector() {
            const monthSelector = document.getElementById('monthSelector');
            const uniqueMonths = [...new Set(allData.map(r => {
                const d = getCorrectDate(r['日付']);
                return d ? `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}` : null;
            }).filter(Boolean))].sort().reverse();
            
            const currentVal = monthSelector.value;
            monthSelector.innerHTML = ''; // Clear existing options
            
            const annualOption = document.createElement('option');
            annualOption.value = 'all';
            annualOption.dataset.langKey = 'annualData';
            annualOption.textContent = translations[currentLang].annualData;
            monthSelector.appendChild(annualOption);

            uniqueMonths.forEach(m => {
                const year = m.split('-')[0];
                const month = parseInt(m.split('-')[1], 10);
                const option = document.createElement('option');
                option.value = m;
                option.textContent = translations[currentLang].yearMonth.replace('{year}', year).replace('{month}', month);
                monthSelector.add(option);
            });

            if (currentVal && monthSelector.querySelector(`[value="${currentVal}"]`)) {
                monthSelector.value = currentVal;
            } else {
                monthSelector.value = monthSelector.options[1] ? monthSelector.options[1].value : 'all';
            }
        }

        function updateDashboard(period) {
            const isAnnualView = period === 'all';
            const filteredOverallData = isAnnualView ? allData : allData.filter(row => {
                const d = getCorrectDate(row['日付']);
                return d && `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}` === period;
            });
            currentFilteredData = isAnnualView ? allParsedCustomerData : allParsedCustomerData.filter(customer => {
                if (!customer.date) return false;
                const customerMonth = `${customer.date.getFullYear()}-${(customer.date.getMonth() + 1).toString().padStart(2, '0')}`;
                return customerMonth === period;
            });
            updateAllSections(filteredOverallData, currentFilteredData, isAnnualView);
        }
        
        function updateAllSections(overallData, customerData, isAnnualView) {
            updateKpis(overallData);
            createPerformanceCharts(overallData, customerData, isAnnualView);
            createCallTypeChart(customerData);
            createAreaAnalysisSection(customerData);
            createArrivalTimeChart(customerData);
            createSourceRatioChart(customerData);
            createCastPerformanceSection(customerData);
            createRaceAnalysisSection(customerData, isAnnualView);
        }

        function updateKpis(data) {
            const totalSales = data.reduce((s, r) => s + (parseFloat(String(r['売上合計']).replace(/,/g, '')) || 0), 0);
            const totalProfit = data.reduce((s, r) => s + (parseFloat(String(r['粗利合計']).replace(/,/g, '')) || 0), 0);
            const totalCost = data.reduce((s, r) => s + (parseFloat(String(r['原価']).replace(/,/g, '')) || 0), 0);
            const totalCustomers = data.reduce((s, r) => s + (parseInt(String(r['客数']).replace(/,/g, ''), 10) || 0), 0);
            document.getElementById('kpi-sales').textContent = formatYen(totalSales);
            document.getElementById('kpi-profit').textContent = formatYen(totalProfit);
            document.getElementById('kpi-cost').textContent = formatYen(totalCost);
            document.getElementById('kpi-customers').textContent = totalCustomers.toLocaleString();
            document.getElementById('kpi-margin-rate').textContent = formatPercent(totalSales > 0 ? totalProfit / totalSales : 0);
            document.getElementById('kpi-avg-spend').textContent = formatYen(totalCustomers > 0 ? totalSales / totalCustomers : 0);
        }

        // --- Chart & Table Rendering ---
        function createPerformanceCharts(overallData, customerData, isAnnualView) {
            const keyFn = isAnnualView ? r => { const d = getCorrectDate(r['日付']); return d ? `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}` : null; } : r => r['日付'];
            const sortFn = isAnnualView ? (a, b) => new Date(a) - new Date(b) : (a, b) => getCorrectDate(a) - getCorrectDate(b);
            
            const aggregated = overallData.reduce((acc, row) => {
                const key = keyFn(row); if (!key) return acc;
                if (!acc[key]) acc[key] = { sales: 0, profit: 0, cost: 0, customers: 0, repeaters: 0 };
                const customers = parseInt(String(row['客数']).replace(/,/g, ''), 10) || 0;
                acc[key].sales += parseFloat(String(row['売上合計']).replace(/,/g, '')) || 0;
                acc[key].profit += parseFloat(String(row['粗利合計']).replace(/,/g, '')) || 0;
                acc[key].cost += parseFloat(String(row['原価']).replace(/,/g, '')) || 0;
                acc[key].customers += customers;
                acc[key].repeaters += Math.round(customers * (parseFloat(String(row['リピーター率']).replace('%', '')) / 100 || 0));
                return acc;
            }, {});

            const sortedKeys = Object.keys(aggregated).sort(sortFn);

            sortedKeys.forEach(key => {
                const periodData = isAnnualView
                    ? customerData.filter(c => c.date && `${c.date.getFullYear()}-${(c.date.getMonth() + 1).toString().padStart(2, '0')}` === key)
                    : customerData.filter(c => c.date && getCorrectDate(key) && c.date.getTime() === getCorrectDate(key).getTime());
                
                aggregated[key].hamanoCustomers = periodData.filter(c => c.source === '濱野経由').length;
            });

            const labels = sortedKeys.map(k => {
                if (isAnnualView) {
                    const [year, month] = k.split('-');
                    return translations[currentLang].yearMonth.replace('{year}', year).replace('{month}', parseInt(month, 10));
                }
                return k;
            });
            renderMainChart(labels, [
                { type: 'bar', label: translations[currentLang].salesLabel, data: sortedKeys.map(k => aggregated[k].sales), backgroundColor: 'rgba(244, 114, 182, 0.7)', yAxisID: 'y-sales' },
                { type: 'bar', label: translations[currentLang].costLabel, data: sortedKeys.map(k => aggregated[k].cost), backgroundColor: 'rgba(156, 163, 175, 0.7)', yAxisID: 'y-sales' },
                { type: 'line', label: translations[currentLang].marginRateLabel, data: sortedKeys.map(k => aggregated[k].sales > 0 ? aggregated[k].profit / aggregated[k].sales : 0), borderColor: '#fbcfe8', borderWidth: 3, tension: 0.3, yAxisID: 'y-margin' }
            ]);
            renderStandardChart('profitBarChart', 'bar', labels, [{ label: translations[currentLang].profitLabel, data: sortedKeys.map(k => aggregated[k].profit), backgroundColor: 'rgba(244, 114, 182, 0.7)' }], formatYen);
            renderStandardChart('customersTrendChart', 'bar', labels, [
                { label: translations[currentLang].newCustomersLabel, data: sortedKeys.map(k => aggregated[k].customers - aggregated[k].repeaters - aggregated[k].hamanoCustomers), backgroundColor: 'rgba(229, 231, 235, 0.7)' },
                { label: translations[currentLang].repeatersLabel, data: sortedKeys.map(k => aggregated[k].repeaters), backgroundColor: '#f9a8d4' },
                { label: translations[currentLang].hamanoSource, data: sortedKeys.map(k => aggregated[k].hamanoCustomers), backgroundColor: '#67e8f9' }
            ], val => val.toLocaleString());
        }
        
        function createCallTypeChart(data) {
            const callTypes = data.reduce((acc, c) => {
                const type = c.callInfo.startsWith('アウトコール') ? 'アウトコール' : 'インコール';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});
            renderChart('call-type-chart', 'doughnut', Object.keys(callTypes).map(t => translateData(t)), [{ data: Object.values(callTypes) }], v => `${v}${translations[currentLang].caseSuffix}`);
        }

        function createAreaAnalysisSection(data) {
            const tokyo23Wards = ['千代田区', '中央区', '港区', '新宿区', '文京区', '台東区', '墨田区', '江東区', '品川区', '目黒区', '大田区', '世田谷区', '渋谷区', '中野区', '杉並区', '豊島区', '北区', '荒川区', '板橋区', '練馬区', '足立区', '葛飾区', '江戸川区'];
            const tokyoData = data.filter(c => c.callInfo.startsWith('アウトコール') && tokyo23Wards.some(ward => c.callInfo.includes(ward)));
            
            const areaStats = tokyoData.reduce((acc, c) => {
                const area = tokyo23Wards.find(ward => c.callInfo.includes(ward));
                if (area) {
                    if (!acc[area]) {
                        acc[area] = { customers: [], totalPayment: 0 };
                    }
                    acc[area].customers.push(c);
                    acc[area].totalPayment += c.payment;
                }
                return acc;
            }, {});

            const sortedAreas = Object.entries(areaStats)
                .map(([area, stats]) => {
                    const customersWithOptions = stats.customers.filter(c => c.options.length > 0).length;
                    const hamanoCustomers = stats.customers.filter(c => c.source === '濱野経由').length;
                    return {
                        area,
                        customerCount: stats.customers.length,
                        avgPayment: stats.customers.length > 0 ? stats.totalPayment / stats.customers.length : 0,
                        optionRate: stats.customers.length > 0 ? customersWithOptions / stats.customers.length : 0,
                        hamanoRate: stats.customers.length > 0 ? hamanoCustomers / stats.customers.length : 0,
                    };
                })
                .sort((a, b) => b.customerCount - a.customerCount);

            const labels = sortedAreas.map(area => translateData(area.area));
            const chartData = sortedAreas.map(area => area.customerCount);

            renderChart('tokyo-barchart', 'bar', labels, [{ label: translations[currentLang].deliveryCount, data: chartData, backgroundColor: 'rgba(244, 114, 182, 0.7)' }], v => `${v}${translations[currentLang].caseSuffix}`, true);
            renderAreaDetailsTable(sortedAreas);
        }

        function renderAreaDetailsTable(data) {
            const tableHead = document.getElementById('area-details-table-head');
            const tableBody = document.getElementById('area-details-table-body');
            tableHead.innerHTML = `<tr>
                <th>${translations[currentLang].areaNameCol}</th>
                <th>${translations[currentLang].totalCustomersCol}</th>
                <th>${translations[currentLang].avgPaymentCol}</th>
                <th>${translations[currentLang].optionRateCol}</th>
                <th>${translations[currentLang].hamanoRateCol}</th>
            </tr>`;
            tableBody.innerHTML = data.map(d => `
                <tr class="clickable" data-ward-name="${d.area}">
                    <td class="font-semibold">${translateData(d.area)}</td>
                    <td>${d.customerCount}</td>
                    <td>${formatYen(d.avgPayment)}</td>
                    <td class="accent-text font-bold">${formatPercent(d.optionRate)}</td>
                    <td class="accent-text font-bold">${formatPercent(d.hamanoRate)}</td>
                </tr>
            `).join('');
        }


        function createArrivalTimeChart(data) {
            const businessHours = ['18', '19', '20', '21', '22', '23', '00', '01', '02', '03', '04'];
            const hourlyCounts = businessHours.reduce((acc, hour) => ({ ...acc, [hour]: 0 }), {});
            data.forEach(customer => {
                const hour = customer.time.split(':')[0];
                if (hour in hourlyCounts) hourlyCounts[hour]++;
            });
            renderChart('arrival-time-chart', 'bar', businessHours.map(h => `${h}:00`), [{ label: translations[currentLang].customerCount, data: businessHours.map(h => hourlyCounts[h]), backgroundColor: 'rgba(244, 114, 182, 0.7)' }], val => `${val}${translations[currentLang].peopleSuffix}`);
        }

        function createSourceRatioChart(data) {
            const sourceCounts = data.reduce((acc, c) => { acc[c.source || '不明'] = (acc[c.source || '不明'] || 0) + 1; return acc; }, {});
            const sortedSources = Object.entries(sourceCounts).sort(([,a],[,b]) => b - a);
            const labels = sortedSources.map(([source]) => translateData(source));
            const chartData = sortedSources.map(([,count]) => count);
            renderChart('source-ratio-chart', 'doughnut', labels, [{ data: chartData }], v => `${v}${translations[currentLang].caseSuffix}`);
        }

        function createCastPerformanceSection(data) {
            currentCastStats = {};
            data.forEach(c => {
                if (!c.castName) return;
                if (!currentCastStats[c.castName]) {
                    currentCastStats[c.castName] = { customerCount: 0, totalPayout: 0, repeatCount: 0, optionCustomerCount: 0, hamanoCustomerCount: 0 };
                }
                currentCastStats[c.castName].customerCount++;
                currentCastStats[c.castName].totalPayout += c.payout;
                if (c.options.length > 0) {
                    currentCastStats[c.castName].optionCustomerCount++;
                }
                if (c.source === '濱野経由') {
                    currentCastStats[c.castName].hamanoCustomerCount++;
                }
            });
            data.forEach(c => {
                if (c.repeatSourceCast && currentCastStats[c.repeatSourceCast]) {
                    currentCastStats[c.repeatSourceCast].repeatCount++;
                }
            });
            const totalPayout = data.reduce((sum, cust) => sum + cust.payout, 0);
            const totalCasts = Object.keys(currentCastStats).length;
            document.getElementById('kpi-total-payout').textContent = formatYen(totalPayout);
            document.getElementById('kpi-avg-payout').textContent = formatYen(data.length > 0 ? totalPayout / data.length : 0);
            renderCastTable();
        }

        function renderCastTable() {
            const tableBody = document.getElementById('cast-performance-table');
            const sortedData = Object.entries(currentCastStats).map(([name, stats]) => ({
                name, ...stats,
                avgPayout: stats.customerCount > 0 ? stats.totalPayout / stats.customerCount : 0,
                repeatRate: stats.customerCount > 0 ? stats.repeatCount / stats.customerCount : 0,
                optionRate: stats.customerCount > 0 ? stats.optionCustomerCount / stats.customerCount : 0,
                hamanoRate: stats.customerCount > 0 ? stats.hamanoCustomerCount / stats.customerCount : 0,
            })).sort((a, b) => (currentSort.direction === 'asc' ? 1 : -1) * (a[currentSort.key] > b[currentSort.key] ? 1 : -1));
            
            tableBody.innerHTML = sortedData.map(stats => `
                <tr class="clickable" data-cast-name="${stats.name}">
                    <td class="font-semibold">${stats.name}</td>
                    <td>${stats.customerCount}</td>
                    <td>${formatYen(stats.totalPayout)}</td>
                    <td>${formatYen(stats.avgPayout)}</td>
                    <td>${stats.repeatCount}</td>
                    <td class="accent-text font-bold">${formatPercent(stats.repeatRate)}</td>
                    <td class="accent-text font-bold">${formatPercent(stats.optionRate)}</td>
                    <td>${stats.hamanoCustomerCount}</td>
                    <td class="accent-text font-bold">${formatPercent(stats.hamanoRate)}</td>
                </tr>`).join('');

            document.querySelectorAll('#cast-table-head th').forEach(th => {
                th.classList.toggle('sorted', th.dataset.sort === currentSort.key);
                const arrowSpan = th.querySelector('.sort-arrow');
                if (arrowSpan) {
                    arrowSpan.textContent = th.dataset.sort === currentSort.key ? (currentSort.direction === 'asc' ? '▲' : '▼') : '';
                }
            });
        }

        function createRaceAnalysisSection(data, isAnnualView) {
            const raceCounts = [...new Set(data.map(c => c.race || '不明'))].map(race => ({ race, count: data.filter(c => (c.race || '不明') === race).length })).sort((a,b) => b.count - a.count);
            renderChart('race-ratio-chart', 'doughnut', raceCounts.map(r => translateData(r.race)), [{ data: raceCounts.map(r => r.count) }], val => `${val}${translations[currentLang].peopleSuffix}`);
            const tableHead = document.getElementById('race-analysis-table-head');
            const tableBody = document.getElementById('race-analysis-table');
            const dataByLabel = data.reduce((acc, c) => {
                const label = isAnnualView ? (c.date ? `${c.date.getFullYear()}-${(c.date.getMonth() + 1).toString().padStart(2, '0')}` : '不明') : (c.race || '不明');
                if (!acc[label]) acc[label] = [];
                acc[label].push(c);
                return acc;
            }, {});
            tableHead.innerHTML = `<tr>
                <th>${isAnnualView ? translations[currentLang].monthCol : translations[currentLang].raceCol}</th>
                <th>${translations[currentLang].totalCustomersCol}</th>
                <th>${translations[currentLang].avgStayCol}</th>
                <th>${translations[currentLang].avgPaymentCol}</th>
                <th>${translations[currentLang].topSourceCol}</th>
                <th>${translations[currentLang].topOptionCol}</th>
                <th>${translations[currentLang].optionRateCol}</th>
                <th>${translations[currentLang].hamanoCountCol}</th>
                <th>${translations[currentLang].hamanoRateCol}</th>
            </tr>`;
            tableBody.innerHTML = Object.keys(dataByLabel).sort().map(label => generateAnalysisRow(label, dataByLabel[label], isAnnualView)).join('');
        }

        function generateAnalysisRow(label, data, isAnnualView) {
            const totalDuration = data.reduce((sum, c) => sum + c.duration, 0);
            const totalPayment = data.reduce((sum, c) => sum + c.payment, 0);
            const sourceCounts = data.reduce((acc, c) => { acc[c.source] = (acc[c.source] || 0) + 1; return acc; }, {});
            const topSource = Object.entries(sourceCounts).sort(([,a],[,b]) => b-a)[0]?.[0] || 'N/A';
            const optionCounts = data.flatMap(c => c.options).reduce((acc, opt) => { acc[opt] = (acc[opt] || 0) + 1; return acc; }, {});
            const topOption = Object.entries(optionCounts).sort(([,a],[,b]) => b-a)[0]?.[0] || 'N/A';
            const customersWithOptions = data.filter(c => c.options.length > 0).length;
            const optionRate = data.length > 0 ? customersWithOptions / data.length : 0;
            const hamanoCustomers = data.filter(c => c.source === '濱野経由').length;
            const hamanoRate = data.length > 0 ? hamanoCustomers / data.length : 0;
            const formattedLabel = isAnnualView ? translations[currentLang].yearMonth.replace('{year}', label.split('-')[0]).replace('{month}', parseInt(label.split('-')[1], 10)) : translateData(label);
            return `<tr class="clickable" data-label="${label}" data-is-annual="${isAnnualView}">
                <td class="font-semibold">${formattedLabel}</td>
                <td>${data.length}</td>
                <td>${(totalDuration / data.length || 0).toFixed(1)}${translations[currentLang].minSuffix}</td>
                <td>${formatYen(totalPayment / data.length)}</td>
                <td>${translateData(topSource)}</td>
                <td>${translateData(topOption)}</td>
                <td class="accent-text font-bold">${formatPercent(optionRate)}</td>
                <td>${hamanoCustomers}</td>
                <td class="accent-text font-bold">${formatPercent(hamanoRate)}</td>
            </tr>`;
        }
        
        // --- Generic Chart Rendering ---
        function renderChart(canvasId, type, labels, datasets, formatterFn, isHorizontal = false) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (window[canvasId + '_instance']) window[canvasId + '_instance'].destroy();
            const options = { responsive: true, maintainAspectRatio: false, indexAxis: isHorizontal ? 'y' : 'x', plugins: { legend: { display: type === 'doughnut', position: 'bottom', labels: { color: '#fce7f3' } }, tooltip: { callbacks: { label: (context) => { const label = context.dataset.label || context.label || ''; const value = context.raw; if (type === 'doughnut') { const total = context.dataset.data.reduce((a, b) => a + b, 0); const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%'; return ` ${label}: ${formatterFn(value)} (${percentage})`; } return ` ${label}: ${formatterFn(value)}`; } } } } };
            if (type === 'bar' || type === 'line') { options.scales = { x: { ticks: { color: '#fbcfe8', precision: 0 }, grid: { color: 'rgba(244, 114, 182, 0.2)' } }, y: { ticks: { color: '#fce7f3' }, grid: { color: 'rgba(244, 114, 182, 0.2)' } } }; if(isHorizontal || type === 'line') { options.scales.x.beginAtZero = true; } else { options.scales.y.beginAtZero = true; } }
            datasets[0].backgroundColor = datasets[0].backgroundColor || PREMIUM_COLORS;
            window[canvasId + '_instance'] = new Chart(ctx, { type, data: { labels, datasets }, options });
        }
        function renderStandardChart(canvasId, type, labels, datasets, formatterFn) { const ctx = document.getElementById(canvasId).getContext('2d'); if (window[canvasId + '_instance']) window[canvasId + '_instance'].destroy(); const isStacked = type === 'bar' && datasets.length > 1; window[canvasId + '_instance'] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: isStacked, ticks: { color: '#fbcfe8' }, grid: { color: 'rgba(244, 114, 182, 0.2)' } }, y: { stacked: isStacked, beginAtZero: true, ticks: { callback: v => formatterFn(v), color: '#fbcfe8' }, grid: { color: 'rgba(244, 114, 182, 0.2)' } } }, plugins: { legend: { display: isStacked, position: 'top', labels: { color: '#fce7f3' } }, tooltip: { callbacks: { label: c => ` ${c.dataset.label || ''}: ${formatterFn(c.parsed.y)}` } } } } }); }
        function renderMainChart(labels, datasets) { const canvasId = 'salesTrendChart'; const ctx = document.getElementById(canvasId).getContext('2d'); if (window[canvasId + '_instance']) window[canvasId + '_instance'].destroy(); window[canvasId + '_instance'] = new Chart(ctx, { type: 'bar', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false, ticks: { color: '#fbcfe8' }, grid: { color: 'rgba(244, 114, 182, 0.2)' } }, 'y-sales': { type: 'linear', position: 'left', beginAtZero: true, ticks: { callback: v => formatYen(v), color: '#fbcfe8' }, grid: { color: 'rgba(244, 114, 182, 0.2)' } }, 'y-margin': { type: 'linear', position: 'right', beginAtZero: true, ticks: { callback: v => formatPercent(v), color: '#fbcfe8' }, grid: { drawOnChartArea: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ${c.dataset.label || ''}: ${c.dataset.yAxisID === 'y-margin' ? formatPercent(c.parsed.y) : formatYen(c.parsed.y)}` } } } } }); }

        // --- Language & Event Listeners ---
        const translations = {
            'ja': {
                mainTitle: "TokyoGirlsHub 総合分析", subTitle: "統合パフォーマンスダッシュボード", refreshBtn: "更新", navAll: "すべて表示", navCustomer: "顧客動向", navCast: "キャスト分析", navRace: "人種別分析", kpiSales: "売上合計", kpiProfit: "粗利合計", kpiCost: "原価合計", kpiCustomers: "客数合計", kpiMarginRate: "粗利率", kpiAvgSpend: "平均客単価", salesTrendTitle: "売上・原価・粗利率 推移", salesLabel: "売上", costLabel: "原価", marginRateLabel: "粗利率", profitTrendTitle: "粗利推移", customerTrendTitle: "客数推移（新規・リピーター）", callTypeTitle: "コール種別 比率", areaMapTitle: "人気配達エリア", areaNameCol: "エリア名", hamanoCountCol: "濱野経由数", arrivalTineTitle: "入客時間帯", sourceRatioTitle: "経由元 比率", castPerfTitle: "キャスト パフォーマンス", kpiTotalPayout: "女子給 合計", kpiAvgPayout: "1人あたり平均女子給", castNameCol: "キャスト名", totalCustomersCol: "総客数", totalPayoutCol: "女子給合計", avgPayoutCol: "客単価女子給", repeatCountCol: "被リピート数", repeatRateCol: "リピート率", raceAnalysisTitle: "人種別 分析", tokyoModalTitle: "東京都内 配達エリア ランキング", wardModalTitle: "詳細分析", totalPaymentCol: "総支払額", avgPaymentCol: "平均支払額", raceRatioTitle: "人種比率", topOptionsTitle: "人気オプション", sourceTitle: "経由元", periodDataTitle: "期間別データ", sourceRankingTitle: "経由元ランキング", topOptionsRankingTitle: "人気オプションランキング", annualData: "年間データ", yearMonth: "{year}年{month}月", profitLabel: "粗利", repeatersLabel: "リピーター", newCustomersLabel: "新規顧客", deliveryCount: "配達件数", caseSuffix: "件", selectionCount: "選択回数", timesSuffix: "回", customerCount: "客数", peopleSuffix: "人", monthCol: "月", raceCol: "人種", avgStayCol: "平均滞在時間", topSourceCol: "人気経由元", topOptionCol: "人気オプション", minSuffix: "分", dateCol: "日付", periodCol: "期間", optionRateCol: "オプション付与率", hamanoRateCol: "濱野経由率", hamanoSource: "濱野経由",
                data: { "日本": "日本", "イラマチオ": "イラマチオ", "インコール": "インコール", "アウトコール": "アウトコール", "不明": "不明", "日本人": "日本人", "中国人": "中国人", "韓国人": "韓国人", "台湾人": "台湾人", "フィリピン人": "フィリピン人", "タイ人": "タイ人", "ベトナム人": "ベトナム人", "その他": "その他", "HP": "HP", "リピ": "リピ", "紹介": "紹介", "X": "X", "Instagram": "Instagram", "TikTok": "TikTok", "オナニー鑑賞": "オナニー鑑賞", "電マ/バイブ": "電マ/バイブ", "聖水": "聖水", "足コキ": "足コキ", "即尺": "即尺", "アナル舐め": "アナル舐め", "パンツ持ち帰り": "パンツ持ち帰り", "パンスト破り": "パンスト破り", "コスプレ": "コスプレ", "ごっくん": "ごっくん", "3P": "3P", "顔射": "顔射", "2回戦(60分限定)": "2回戦(60分限定)", "写真動画撮影": "写真動画撮影", "AF": "AF", "N/A": "該当なし", "千代田区": "千代田区", "中央区": "中央区", "港区": "港区", "新宿区": "新宿区", "文京区": "文京区", "台東区": "台東区", "墨田区": "墨田区", "江東区": "江東区", "品川区": "品川区", "目黒区": "目黒区", "大田区": "大田区", "世田谷区": "世田谷区", "渋谷区": "渋谷区", "中野区": "中野区", "杉並区": "杉並区", "豊島区": "豊島区", "北区": "北区", "荒川区": "荒川区", "板橋区": "板橋区", "練馬区": "練馬区", "足立区": "足立区", "葛飾区": "葛飾区", "江戸川区": "江戸川区", "アメリカ": "アメリカ", "イギリス": "イギリス", "カナダ": "カナダ", "シンガポール": "シンガポール", "メキシコ": "メキシコ", "ヨーロッパ系": "ヨーロッパ系", "中東系": "中東系", "香港": "香港", "外販": "外販", "Web予約": "Web予約", "Echoさん経由": "Echoさん経由", "該当なし": "該当なし", "中国": "中国", "韓国": "韓国", "台湾": "台湾", "姫予約": "姫予約", "渡邊さん経由": "渡邊さん経由", "渡辺さん経由": "渡辺さん経由", "飛び込み": "飛び込み", "マイ客": "マイ客", "濱野マイ客": "濱野マイ客", "カイマイ客": "カイマイ客", "マーカスマイ客": "マーカスマイ客", "香港Discord": "香港Discord", "リピーター": "リピーター", "濱野マイ客紹介": "濱野マイ客紹介", "濱野引き": "濱野引き", "渡辺さんマイ客": "渡辺さんマイ客", "ロシア": "ロシア", "インド": "インド", "タイ": "タイ", "ドバイ": "ドバイ", "トルコ": "トルコ", "濱野経由": "濱野経由" }
            },
            'en': {
                mainTitle: "TokyoGirlsHub Comprehensive Analysis", subTitle: "Integrated Performance Dashboard", refreshBtn: "Refresh", navAll: "Show All", navCustomer: "Customer Trends", navCast: "Cast Analysis", navRace: "Race Analysis", kpiSales: "Total Sales", kpiProfit: "Total Profit", kpiCost: "Total Cost", kpiCustomers: "Total Customers", kpiMarginRate: "Profit Margin", kpiAvgSpend: "Avg. Spend", salesTrendTitle: "Sales, Cost & Margin Rate Trend", salesLabel: "Sales", costLabel: "Cost", marginRateLabel: "Margin %", profitTrendTitle: "Profit Trend", customerTrendTitle: "Customer Trend (New/Repeat)", callTypeTitle: "Call Type Ratio", areaMapTitle: "Popular Delivery Areas", areaNameCol: "Area", hamanoCountCol: "Via Hamano Count", arrivalTineTitle: "Peak Hours", sourceRatioTitle: "Source Ratio", castPerfTitle: "Cast Performance", kpiTotalPayout: "Total Payout", kpiAvgPayout: "Avg. Payout per Person", castNameCol: "Cast Name", totalCustomersCol: "Total Customers", totalPayoutCol: "Total Payout", avgPayoutCol: "Avg. Payout/Customer", repeatCountCol: "Repeat Count", repeatRateCol: "Repeat Rate", raceAnalysisTitle: "Analysis by Race", tokyoModalTitle: "Tokyo Ward Delivery Ranking", wardModalTitle: "Detailed Analysis", totalPaymentCol: "Total Payment", avgPaymentCol: "Avg. Payment", raceRatioTitle: "Race Ratio", topOptionsTitle: "Top Options", sourceTitle: "Source", periodDataTitle: "Data by Period", sourceRankingTitle: "Source Ranking", topOptionsRankingTitle: "Top Options Ranking", annualData: "Annual Data", yearMonth: "{month}/{year}", profitLabel: "Profit", repeatersLabel: "Repeaters", newCustomersLabel: "New Customers", deliveryCount: "Deliveries", caseSuffix: " cases", selectionCount: "Selections", timesSuffix: " times", customerCount: "Customers", peopleSuffix: " people", monthCol: "Month", raceCol: "Race", avgStayCol: "Avg. Stay", topSourceCol: "Top Source", topOptionCol: "Top Option", minSuffix: " min", dateCol: "Date", periodCol: "Period", optionRateCol: "Option Rate", hamanoRateCol: "% Via Hamano", hamanoSource: "Via Hamano",
                data: { "日本": "Japan", "イラマチオ": "Deep Throat", "インコール": "In-call", "アウトコール": "Out-call", "不明": "Unknown", "日本人": "Japanese", "中国人": "Chinese", "韓国人": "Korean", "台湾人": "Taiwanese", "フィリピン人": "Filipino", "タイ人": "Thai", "ベトナム人": "Vietnamese", "その他": "Other", "HP": "HP", "リピ": "Repeat", "紹介": "Referral", "X": "X", "Instagram": "Instagram", "TikTok": "TikTok", "オナニー鑑賞": "Viewing", "電マ/バイブ": "Vibrator", "聖水": "Watersports", "足コキ": "Foot Job", "即尺": "Quick Fellatio", "アナル舐め": "Rimming", "パンツ持ち帰り": "Panty Take-home", "パンスト破り": "Stocking Ripping", "コスプレ": "Cosplay", "ごっくん": "Swallowing", "3P": "Threesome", "顔射": "Facial", "2回戦(60分限定)": "2nd Round (60min)", "写真動画撮影": "Photo/Video", "AF": "AF", "N/A": "N/A", "千代田区": "Chiyoda", "中央区": "Chuo", "港区": "Minato", "新宿区": "Shinjuku", "文京区": "Bunkyo", "台東区": "Taito", "墨田区": "Sumida", "江東区": "Koto", "品川区": "Shinagawa", "目黒区": "Meguro", "大田区": "Ota", "世田谷区": "Setagaya", "渋谷区": "Shibuya", "中野区": "Nakano", "杉並区": "Suginami", "豊島区": "Toshima", "北区": "Kita", "荒川区": "Arakawa", "板橋区": "Itabashi", "練馬区": "Nerima", "足立区": "Adachi", "葛飾区": "Katsushika", "江戸川区": "Edogawa", "アメリカ": "America", "イギリス": "UK", "カナダ": "Canada", "シンガポール": "Singapore", "メキシコ": "Mexico", "ヨーロッパ系": "European", "中東系": "Middle Eastern", "香港": "Hong Kong", "外販": "External Sales", "Web予約": "Web Booking", "Echoさん経由": "Via Echo", "該当なし": "N/A", "中国": "China", "韓国": "Korea", "台湾": "Taiwan", "姫予約": "Hime Booking", "渡邊さん経由": "Via Watanabe", "渡辺さん経由": "Via Watanabe", "飛び込み": "Walk-in", "マイ客": "Personal Client", "濱野マイ客": "Hamano's Customer", "カイマイ客": "Kai's Customer", "マーカスマイ客": "Marcus's Customer", "香港Discord": "HK Discord", "リピーター": "Repeater", "濱野マイ客紹介": "Hamano's Customer Referral", "濱野引き": "Brought by Hamano", "渡辺さんマイ客": "Watanabe's Customer", "ロシア": "Russia", "インド": "India", "タイ": "Thailand", "ドバイ": "Dubai", "トルコ": "Turkey", "濱野経由": "Via Hamano" }
            },
            'zh-HK': {
                mainTitle: "TokyoGirlsHub 綜合分析", subTitle: "綜合表現儀表板", refreshBtn: "刷新", navAll: "顯示全部", navCustomer: "顧客趨勢", navCast: "演員分析", navRace: "種族分析", kpiSales: "總銷售額", kpiProfit: "總利潤", kpiCost: "總成本", kpiCustomers: "總顧客數", kpiMarginRate: "利潤率", kpiAvgSpend: "平均消費", salesTrendTitle: "銷售、成本及利潤率趨勢", salesLabel: "銷售額", costLabel: "成本", marginRateLabel: "利潤率", profitTrendTitle: "利潤趨勢", customerTrendTitle: "顧客趨勢（新客/熟客）", callTypeTitle: "來電類型比例", areaMapTitle: "熱門配送區域", areaNameCol: "區域", hamanoCountCol: "經由濱野數", arrivalTineTitle: "高峰時段", sourceRatioTitle: "來源比例", castPerfTitle: "演員表現", kpiTotalPayout: "總支付額", kpiAvgPayout: "人均支付額", castNameCol: "演員名稱", totalCustomersCol: "總顧客數", totalPayoutCol: "總支付額", avgPayoutCol: "每客平均支付", repeatCountCol: "回頭客次數", repeatRateCol: "回頭率", raceAnalysisTitle: "按種族分析", tokyoModalTitle: "東京區內配送排名", wardModalTitle: "詳細分析", totalPaymentCol: "總支付額", avgPaymentCol: "平均支付額", raceRatioTitle: "種族比例", topOptionsTitle: "熱門選項", sourceTitle: "來源", periodDataTitle: "按時期數據", sourceRankingTitle: "來源排名", topOptionsRankingTitle: "熱門選項排名", annualData: "年度數據", yearMonth: "{year}年{month}月", profitLabel: "利潤", repeatersLabel: "熟客", newCustomersLabel: "新客", deliveryCount: "配送次數", caseSuffix: "次", selectionCount: "選擇次數", timesSuffix: "次", customerCount: "顧客數", peopleSuffix: "人", monthCol: "月份", raceCol: "種族", avgStayCol: "平均逗留時間", topSourceCol: "熱門來源", topOptionCol: "熱門選項", minSuffix: "分鐘", dateCol: "日期", periodCol: "期間", optionRateCol: "選項附加率", hamanoRateCol: "經由濱野%", hamanoSource: "經由濱野",
                data: { "日本": "日本", "イラマチオ": "深喉", "インコール": "內線電話", "アウトコール": "外線電話", "不明": "未知", "日本人": "日本人", "中国人": "中國人", "韓国人": "韓國人", "台湾人": "台灣人", "フィリピン人": "菲律賓人", "タイ人": "泰國人", "ベトナム人": "越南人", "その他": "其他", "HP": "HP", "リピ": "回頭客", "紹介": "介紹", "X": "X", "Instagram": "Instagram", "TikTok": "TikTok", "オナニー鑑賞": "觀賞", "電マ/バイブ": "按摩器", "聖水": "聖水", "足コキ": "足交", "即尺": "即刻口交", "アナル舐め": "舔肛", "パンツ持ち帰り": "內褲帶走", "パンスト破り": "撕破絲襪", "コスプレ": "角色扮演", "ごっくん": "吞嚥", "3P": "3P", "顔射": "顏射", "2回戦(60分限定)": "第二回合 (60分鐘)", "写真動画撮影": "拍照錄影", "AF": "AF", "N/A": "無", "千代田区": "千代田區", "中央区": "中央區", "港区": "港區", "新宿区": "新宿區", "文京区": "文京區", "台東区": "台東區", "墨田区": "墨田區", "江東区": "江東區", "品川区": "品川區", "目黒区": "目黑區", "大田区": "大田區", "世田谷区": "世田谷區", "渋谷区": "澀谷區", "中野区": "中野區", "杉並区": "杉並區", "豊島区": "豐島區", "北区": "北區", "荒川区": "荒川區", "板橋区": "板橋區", "練馬区": "練馬區", "足立区": "足立區", "葛飾区": "葛飾區", "江戸川区": "江戶川區", "アメリカ": "美國", "イギリス": "英國", "カナダ": "加拿大", "シンガポール": "新加坡", "メキシコ": "墨西哥", "ヨーロッパ系": "歐洲裔", "中東系": "中東裔", "香港": "香港", "外販": "外部銷售", "Web予約": "網上預約", "Echoさん経由": "經由Echo", "該当なし": "無", "中国": "中國", "韓国": "韓國", "台湾": "台灣", "姫予約": "公主預約", "渡邊さん経由": "經由渡邊", "渡辺さん経由": "經由渡邊", "飛び込み": "街客", "マイ客": "私人客戶", "濱野マイ客": "濱野的私人客戶", "カイマイ客": "Kai的私人客戶", "マーカスマイ客": "Marcus的私人客戶", "香港Discord": "香港Discord", "リピーター": "回頭客", "濱野マイ客紹介": "濱野的客戶介紹", "濱野引き": "由濱野帶來", "渡辺さんマイ客": "渡邊的私人客戶", "ロシア": "俄羅斯", "インド": "印度", "タイ": "泰國", "ドバイ": "杜拜", "トルコ": "土耳其", "濱野経由": "經由濱野" }
            }
        };

        function translateData(key) {
            return translations[currentLang]?.data?.[key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            populateMonthSelector();
            updateDashboard(document.getElementById('monthSelector').value);
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchDataAndProcess();

            document.getElementById('refreshDataBtn').addEventListener('click', fetchDataAndProcess);
            document.getElementById('monthSelector').addEventListener('change', e => updateDashboard(e.target.value));
            
            document.querySelector('nav').addEventListener('click', e => {
                if (e.target.matches('.nav-btn')) {
                    const sectionId = e.target.dataset.section;
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.dashboard-section').forEach(sec => {
                        sec.style.display = (sectionId === 'all' || sec.id === sectionId) ? 'grid' : 'none';
                    });
                }
            });

            document.getElementById('language-switcher').addEventListener('click', e => {
                if(e.target.matches('.lang-btn')) {
                    const lang = e.target.dataset.lang;
                    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    setLanguage(lang);
                }
            });
            
            document.querySelectorAll('[data-close-modal]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal-overlay');
                    modal.classList.remove('visible');
                    if (modal.id === 'ward-detail-modal') ['ward-race-chart', 'ward-options-chart', 'ward-source-chart'].forEach(id => { if(window[id+'_instance']) window[id+'_instance'].destroy(); });
                    if (modal.id === 'castDetailModal') { if(window['cast-options-chart_instance']) window['cast-options-chart_instance'].destroy(); }
                    if (modal.id === 'raceDetailModal') { if(window['race-source-chart_instance']) window['race-source-chart_instance'].destroy(); if(window['race-options-chart_instance']) window['race-options-chart_instance'].destroy(); }
                });
            });

            document.getElementById('salesChartToggles').addEventListener('click', e => {
                const btn = e.target.closest('.slicer-btn');
                if (!btn) return;
                const chart = window['salesTrendChart_instance'];
                if (!chart) return;
                const index = parseInt(btn.dataset.datasetIndex, 10);
                chart.setDatasetVisibility(index, !chart.isDatasetVisible(index));
                btn.classList.toggle('active');
                chart.update();
            });

            document.getElementById('cast-table-head').addEventListener('click', e => {
                const th = e.target.closest('th'); if (!th || !th.dataset.sort) return;
                const sortKey = th.dataset.sort;
                if (currentSort.key === sortKey) { currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; } else { currentSort.key = sortKey; currentSort.direction = 'desc'; }
                renderCastTable();
            });

            document.getElementById('cast-performance-table').addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (row && row.dataset.castName) {
                    document.getElementById('cast-modal-name').textContent = row.dataset.castName;
                    const castData = currentFilteredData.filter(c => c.castName === row.dataset.castName);
                    const optionsCount = castData.flatMap(c => c.options).reduce((acc, option) => { acc[option] = (acc[option] || 0) + 1; return acc; }, {});
                    const sortedOptions = Object.entries(optionsCount).sort(([,a],[,b]) => b-a);
                    renderChart('cast-options-chart', 'doughnut', sortedOptions.map(([opt])=>translateData(opt)), [{ data: sortedOptions.map(([,cnt])=>cnt) }], v => `${v}${translations[currentLang].caseSuffix}`);
                    
                    const isAnnualView = document.getElementById('monthSelector').value === 'all';
                    const aggregationKeyFn = isAnnualView ? c => c.date ? `${c.date.getFullYear()}-${(c.date.getMonth() + 1).toString().padStart(2, '0')}` : null : c => c.date ? c.date.toISOString().split('T')[0] : null;
                    const labelFormatFn = isAnnualView ? key => translations[currentLang].yearMonth.replace('{year}', key.split('-')[0]).replace('{month}', parseInt(key.split('-')[1], 10)) : key => { const d = new Date(key); return `${d.getUTCMonth() + 1}/${d.getUTCDate()}` };
                    const dataByPeriod = castData.reduce((acc, customer) => { const key = aggregationKeyFn(customer); if (key) { if (!acc[key]) acc[key] = []; acc[key].push(customer); } return acc; }, {});
                    const tableHead = document.getElementById('cast-detail-table-head');
                    const tableBody = document.getElementById('cast-detail-table-body');
                    tableHead.innerHTML = `<tr>
                        <th>${translations[currentLang].periodCol}</th>
                        <th>${translations[currentLang].customerCount}</th>
                        <th>${translations[currentLang].totalPayoutCol}</th>
                        <th>${translations[currentLang].avgPayoutCol}</th>
                    </tr>`;
                    tableBody.innerHTML = Object.keys(dataByPeriod).sort((a,b) => new Date(a) - new Date(b)).map(key => {
                        const periodData = dataByPeriod[key];
                        const totalPayout = periodData.reduce((sum, c) => sum + c.payout, 0);
                        return `<tr><td>${labelFormatFn(key)}</td><td>${periodData.length}</td><td>${formatYen(totalPayout)}</td><td>${formatYen(totalPayout / periodData.length)}</td></tr>`;
                    }).join('');

                    document.getElementById('castDetailModal').classList.add('visible');
                }
            });

            document.getElementById('race-analysis-table').addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (row && row.dataset.label) {
                    const label = row.dataset.label;
                    const isAnnual = row.dataset.isAnnual === 'true';
                    const data = isAnnual 
                        ? currentFilteredData.filter(c => c.date && `${c.date.getFullYear()}-${(c.date.getMonth() + 1).toString().padStart(2, '0')}` === label)
                        : currentFilteredData.filter(c => (c.race || '不明') === label);
                    document.getElementById('race-modal-name').textContent = isAnnual ? translations[currentLang].yearMonth.replace('{year}', label.split('-')[0]).replace('{month}', parseInt(label.split('-')[1], 10)) : translateData(label);
                    
                    const sourceCounts = data.reduce((acc, c) => { acc[c.source || '不明'] = (acc[c.source || '不明'] || 0) + 1; return acc; }, {});
                    renderChart('race-source-chart', 'doughnut', Object.keys(sourceCounts).map(s => translateData(s)), [{ data: Object.values(sourceCounts) }], v => `${v}${translations[currentLang].caseSuffix}`);

                    const optionsCount = data.flatMap(c => c.options).reduce((acc, option) => { acc[option] = (acc[option] || 0) + 1; return acc; }, {});
                    const sortedOptions = Object.entries(optionsCount).sort(([,a],[,b]) => b-a);
                    renderChart('race-options-chart', 'doughnut', sortedOptions.map(([opt])=>translateData(opt)), [{ data: sortedOptions.map(([,cnt])=>cnt) }], v => `${v}${translations[currentLang].caseSuffix}`);

                    const tableHead = document.getElementById('race-detail-table-head');
                    const tableBody = document.getElementById('race-detail-table-body');
                    if(isAnnual) {
                        tableHead.innerHTML = `<tr>
                            <th>${translations[currentLang].raceCol}</th>
                            <th>${translations[currentLang].totalCustomersCol}</th>
                            <th>${translations[currentLang].avgStayCol}</th>
                            <th>${translations[currentLang].avgPaymentCol}</th>
                        </tr>`;
                        const racesInMonth = [...new Set(data.map(c => c.race || '不明'))];
                        tableBody.innerHTML = racesInMonth.map(race => {
                            const dataForRaceInMonth = data.filter(c => (c.race || '不明') === race);
                            if (dataForRaceInMonth.length === 0) return '';
                            const totalDuration = dataForRaceInMonth.reduce((sum, c) => sum + c.duration, 0);
                            const totalPayment = dataForRaceInMonth.reduce((sum, c) => sum + c.payment, 0);
                            return `<tr><td class="font-semibold">${translateData(race)}</td><td>${dataForRaceInMonth.length}</td><td>${(totalDuration / dataForRaceInMonth.length).toFixed(1)}${translations[currentLang].minSuffix}</td><td>${formatYen(totalPayment / dataForRaceInMonth.length)}</td></tr>`;
                        }).join('');
                    } else {
                         tableHead.innerHTML = `<tr>
                            <th>${translations[currentLang].dateCol}</th>
                            <th>${translations[currentLang].customerCount}</th>
                            <th>${translations[currentLang].avgStayCol}</th>
                            <th>${translations[currentLang].avgPaymentCol}</th>
                        </tr>`;
                         const dailyData = data.reduce((acc, c) => { const dayKey = c.date.toISOString().split('T')[0]; if(!acc[dayKey]) acc[dayKey] = []; acc[dayKey].push(c); return acc; }, {});
                         tableBody.innerHTML = Object.keys(dailyData).sort().map(day => {
                             const dataForDay = dailyData[day];
                             const totalDuration = dataForDay.reduce((sum, c) => sum + c.duration, 0);
                             const totalPayment = dataForDay.reduce((sum, c) => sum + c.payment, 0);
                             const d = new Date(day);
                             return `<tr><td class="font-semibold">${d.getUTCMonth() + 1}/${d.getUTCDate()}</td><td>${dataForDay.length}</td><td>${(totalDuration/dataForDay.length).toFixed(1)}${translations[currentLang].minSuffix}</td><td>${formatYen(totalPayment/dataForDay.length)}</td></tr>`;
                         }).join('');
                    }

                    document.getElementById('raceDetailModal').classList.add('visible');
                }
            });

        });
    </script>
</body>
</html>
